<html>
    <head>
            <link rel="manifest" href="/manifest.json" />
            <title>Web API Example</title></head>
    <body>
        <span id="welcomemsg">You will be asked for permission to notify</span>
    <script>

window.vapidPublicKey = new Uint8Array("BKur2LFDqc57hoeqYCh3gc8wEUbNxl7gSnd9tEyMdJCOOrG9mYnoKnsCQyH9ESrdiak8_OmLO1XjlAeGbz52PXU");

    // Let's check if the browser supports notifications
if (!("Notification" in window)) {
  console.error("This browser does not support desktop notification");
}

// Let's check whether notification permissions have already been granted
else if (Notification.permission === "granted") {
  console.log("Permission to receive notifications has been granted");
}

// Otherwise, we need to ask the user for permission
else if (Notification.permission !== 'denied') {
  Notification.requestPermission(function (permission) {
  // If the user accepts, let's create a notification
    if (permission === "granted") {
      console.log("Permission to receive notifications has been granted. Registering ServiceWorker.js");
 
        // Register the serviceWorker script at /serviceworker.js from our server if supported
        if (navigator.serviceWorker) {

            navigator.serviceWorker.ready.then((serviceWorkerRegistration) => {
                serviceWorkerRegistration.pushManager
                .subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: window.vapidPublicKey
                })
                .then(function (subcription) {
                    console.log("Connecting to backend server with the subscriptiopn",subcription.toJSON());

                    var fields = {endpoint:sub.endpoint,token:sub.keys.p256dh,auth:sub.keys.auth};

                    fetch('/newbrowser', {
                        method: 'POST',
                        body: JSON.stringify(fields)
                    }).then(function(response) {
                        return response.json();
                    }).then(function(data) {
                        console.dir(data);
                    });
                });;
            });

            navigator.serviceWorker.register('/serviceworker.js')
            .then(function(reg) {
                console.log('Service worker change, registered the service worker');
            });

            // Let's communicate with the server about our information

            https://rossta.net/blog/using-the-web-push-api-with-vapid.html

        }
        // Otherwise, no push notifications :(
        else {
        console.error('Service worker is not supported in this browser');
        }
        // Service Worker Registration END
        
    }
  });
}


    
    
    
 



    </script>
    </body>
</html>